# 云原生管理（按契约边界）

这是一个活文档。`Progress`、`Surprises & Discoveries`、`Decision Log`、`Outcomes & Retrospective` 这四个部分在实施过程中必须持续更新。

本计划必须遵循仓库内 `docs/execplans/PLANS.md` 的要求和格式。

## Purpose / Big Picture / 目的与总览

完成本计划后，每个契约边界（以 `contracts/openapi/*.yaml` 为准）都有独立的 Dockerfile 和 docker-compose 片段，开发者可以按域独立构建、启动或组合运行。Makefile 提供统一入口来启动本地栈、构建镜像、应用 Kubernetes 清单，并且为 CI/CD 提供可复用的命令。CI/CD（持续集成/持续交付）将覆盖后端与前端的测试与静态检查、容器镜像构建与推送，以及可选的开发环境部署；可以通过 GitHub Actions 的流水线日志与运行结果看到这些能力是否生效。

## Progress

- [x] (2026-01-18 14:28Z) 创建了按契约边界的云原生管理 ExecPlan 初稿。
- [x] (2026-01-18 14:35Z) 将计划改为中文并纳入 CI/CD 范畴。
- [ ] 盘点契约边界与现有运行服务，形成边界到镜像/compose 片段的明确映射。
- [ ] 为每个边界新增 Dockerfile（commerce 为真实构建，其余为 stub 容器），并补充入口、端口与环境变量说明。
- [ ] 在 `infra/dev/` 下新增 compose 片段文件，并保持基础依赖在 `infra/dev/docker-compose.yml` 中。
- [ ] 增加 Kubernetes 与可选观测性资产，并补充一份云原生方案设计说明文档。
- [ ] 新增 CI/CD 工作流（测试、lint、构建推送镜像、可选部署），并用 Makefile 统一封装入口。

## Surprises & Discoveries

- Observation: 目前只有 `services/commerce/cmd/commerce/main.go` 可运行，identity/payment/gateway-bff 暂无入口。
  Evidence: `find services -type f -name main.go` 仅返回 commerce 路径。
- Observation: 现有 compose 文件仅有 `infra/dev/docker-compose.yml`，且只包含 Postgres 服务。
  Evidence: `infra/dev/docker-compose.yml` 只有 `postgres` 定义。
- Observation: 已有一个 `commerce-ci` GitHub Actions 工作流。
  Evidence: `.github/workflows/commerce-ci.yml` 存在且运行 go test 与 golangci-lint。

## Decision Log

- Decision: Dockerfile 统一放在 `infra/docker/<boundary>/Dockerfile`，未实现服务用 stub 容器占位。
  Rationale: 既能体现契约边界，又不阻塞当前实现。
  Date/Author: 2026-01-18 (Codex)
- Decision: docker-compose 使用“基础依赖 + 边界片段”组合方式运行。
  Rationale: 便于按域启动并减少单一大文件维护成本。
  Date/Author: 2026-01-18 (Codex)
- Decision: CI/CD 使用 GitHub Actions，并以路径触发拆分后端、前端、镜像构建与部署流程。
  Rationale: 结合现有 workflow，降低变更范围，同时支持按域触发与并行执行。
  Date/Author: 2026-01-18 (Codex)
- Decision: 镜像发布到 GHCR，部署使用 kustomize 覆盖镜像标签，并以 GitHub Environment 控制部署权限（如需）。
  Rationale: GHCR 可直接使用 GITHUB_TOKEN 推送；kustomize 便于环境差异化管理。
  Date/Author: 2026-01-18 (Codex)

## Outcomes & Retrospective

暂无结果，待完成主要里程碑后补充。

## Context and Orientation / 背景与现状

契约边界由 `contracts/README.md` 与 `contracts/openapi/*.yaml` 定义，包括 identity、commerce、payment、admin、ai。服务运行现状见 `services/README.md`，目前只有 commerce 有可执行入口 `services/commerce/cmd/commerce/main.go`，并提供 `/health` 探针。基础 compose 在 `infra/dev/docker-compose.yml`，仅包含 Postgres。本仓库已存在 `commerce-ci` GitHub Actions 工作流（`.github/workflows/commerce-ci.yml`）以及统一脚本 `tools/scripts/test-backend.sh` 和 `package.json` 中的 lint/test 脚本。

本文中的“docker-compose 片段”指的是按边界拆分的 compose 文件，与基础依赖文件组合使用。CI/CD 是“持续集成/持续交付”，即自动执行 lint 与测试、构建镜像、推送镜像、触发部署。GitHub Actions 是仓库内的 CI/CD 执行器，GHCR 是 GitHub 的容器镜像仓库，kustomize 是 Kubernetes 清单的分层覆盖机制。

## Plan of Work / 工作计划

第一阶段聚焦边界与容器化落地。明确每个契约边界对应的镜像名称、Dockerfile 路径、端口与环境变量。为 commerce 编写多阶段 Go 构建 Dockerfile；对 identity/payment/admin/ai/gateway-bff 使用 stub 容器（简单 HTTP 服务器，`/health` 返回可读的“not implemented”消息），以保证边界可见且可组合启动。根目录补充 `.dockerignore` 以缩小构建上下文。

第二阶段完成 compose 结构。保留 `infra/dev/docker-compose.yml` 作为基础依赖（Postgres 等），新增 `infra/dev/compose.<boundary>.yml` 作为边界片段。commerce 片段需依赖 Postgres，并设置 `COMMERCE_DB_DSN` 指向容器内地址；未实现的边界使用 `profiles: ["future"]` 或类似方式默认不启动，避免阻塞本地开发。Makefile 为常用组合（如 stage-0）提供快捷入口。

第三阶段补齐云原生资产与设计说明。新增 `infra/k8s/base` 与 `infra/k8s/overlays/dev`，包含 Deployments、Services、ConfigMaps 与必要的探针定义；生产建议使用托管 Postgres，dev overlay 可提供 StatefulSet 或外部连接占位。新增 `docs/cloud-native.md`，描述可选增强方案（如 Ingress、HPA、PDB、NetworkPolicy、密钥管理、GitOps 与镜像安全扫描）及它们在本仓库中的落点与取舍理由。

第四阶段规划 CI/CD。扩展并规范 GitHub Actions：后端 CI 运行 `tools/scripts/test-backend.sh` 与 lint（可新增 `tools/scripts/lint-backend.sh` 以遍历 Go 模块）；前端 CI 运行 `pnpm -C apps/miniapp lint`。容器构建与推送使用 `docker buildx`，按边界矩阵构建 `infra/docker/<boundary>/Dockerfile`，并推送至 `ghcr.io/<owner>/tmo-<boundary>:<git-sha>`，主分支追加 `latest`。部署流程可使用 `workflow_dispatch` 或 main 分支触发，读取 `KUBE_CONFIG_DATA` 等机密并 `kubectl apply -k infra/k8s/overlays/dev`。

## Concrete Steps / 具体步骤

从仓库根目录确认当前边界与服务状况：

    ls contracts/openapi
    cat services/README.md
    find services -type f -name main.go
    ls .github/workflows

创建 Dockerfile 目录结构与 `.dockerignore`，并为每个边界新增 Dockerfile（commerce 为真实构建，其它边界为 stub）：

    mkdir -p infra/docker/commerce infra/docker/identity infra/docker/payment infra/docker/admin infra/docker/ai infra/docker/gateway-bff

在 `infra/dev/` 下新增 compose 片段，并保持基础依赖在 `infra/dev/docker-compose.yml` 中：

    ls infra/dev
    cp infra/dev/docker-compose.yml infra/dev/docker-compose.yml.bak
    # 新增 infra/dev/compose.<boundary>.yml 文件

构建与校验 compose 组合（以 commerce 为例）：

    docker compose -f infra/dev/docker-compose.yml -f infra/dev/compose.commerce.yml config
    docker build -f infra/docker/commerce/Dockerfile -t tmo/commerce:dev .

新增 Kubernetes 清单与云原生方案说明文档，然后验证（如有 kubectl）：

    ls infra
    kubectl apply -k infra/k8s/overlays/dev
    kubectl get pods

补齐 CI/CD 工作流与脚本（路径示例）：

    ls .github/workflows
    ls tools/scripts
    cat package.json

更新 `Makefile` 并检查帮助输出是否覆盖新命令：

    make help

## Validation and Acceptance / 验证与验收

本地层面，`make dev-up` 可以启动 Postgres 与 commerce 容器，`curl http://localhost:8080/health` 返回 `OK`。`docker compose -f infra/dev/docker-compose.yml -f infra/dev/compose.commerce.yml config` 应通过验证，`make docker-build SERVICE=commerce` 生成 `tmo/commerce:dev` 镜像。Kubernetes 资产存在时，`kubectl apply -k infra/k8s/overlays/dev` 后相关 Pod 进入 Ready，端口转发到 commerce 服务后 `/health` 返回 `OK`。

CI/CD 层面，PR 修改 `services/commerce` 或 `tools/scripts` 时，后端 CI 任务会通过并输出测试与 lint 结果；修改 `apps/miniapp` 时，前端 lint 任务通过。合并到 main 后，镜像构建工作流会在 GHCR 生成包含 `<git-sha>` 与 `latest` 的镜像标签。手动触发部署工作流（若配置）后，Kubernetes 集群中镜像版本更新到新标签且服务可用。

## Idempotence and Recovery / 可重复与恢复

所有步骤应可重复执行。compose 可用 `docker compose ... down` 停止并用 `-v` 清理数据。Kubernetes 可用 `kubectl delete -k infra/k8s/overlays/dev` 清理资源。CI/CD 失败时可以重跑 workflow，镜像回滚可通过指定旧标签并重新 `kubectl apply -k` 实现。

## Artifacts and Notes / 产物与记录

期望输出示例：

    $ docker compose -f infra/dev/docker-compose.yml -f infra/dev/compose.commerce.yml ps
    NAME              STATUS
    tmo-postgres      Up (healthy)
    tmo-commerce      Up

    $ curl http://localhost:8080/health
    OK

## Interfaces and Dependencies / 接口与依赖

所有容器统一暴露 8080 端口，并提供 `/health`。commerce 使用 `COMMERCE_HTTP_ADDR`、`COMMERCE_DB_DSN`、`COMMERCE_LOG_LEVEL`，其中 `COMMERCE_DB_DSN` 在 compose 中指向 Postgres 容器。stub 服务使用简易 HTTP 服务器，返回可读的占位信息。CI/CD 依赖 GitHub Actions；镜像推送使用 `GITHUB_TOKEN` 并设置 workflow `permissions: packages: write`；部署需要 `KUBE_CONFIG_DATA`（base64 kubeconfig）与可选 `K8S_NAMESPACE`。镜像命名统一为 `ghcr.io/<owner>/tmo-<boundary>:<tag>`，标签至少包含 Git 提交 SHA。

## Plan Revision Note

2026-01-18：将计划改为中文并加入 CI/CD 与云原生增强方案设计范围，以满足“基建完善”的新增诉求。
