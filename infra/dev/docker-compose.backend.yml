version: "3.9"

services:
  identity:
    build:
      context: ../..
      dockerfile: services/identity/Dockerfile
    environment:
      IDENTITY_HTTP_ADDR: ":8081"
      IDENTITY_DB_DSN: "postgres://commerce:commerce@postgres:5432/identity?sslmode=disable"
      IDENTITY_LOGIN_MODE: "${IDENTITY_LOGIN_MODE:-real}"
      IDENTITY_JWT_SECRET: "${IDENTITY_JWT_SECRET:-dev-secret}"
      IDENTITY_JWT_ISSUER: "${IDENTITY_JWT_ISSUER:-tmo-identity}"
      IDENTITY_WEAPP_APPID: "${IDENTITY_WEAPP_APPID:-}"
      IDENTITY_WEAPP_APPSECRET: "${IDENTITY_WEAPP_APPSECRET:-}"
      IDENTITY_WEAPP_TOKEN_URL: "${IDENTITY_WEAPP_TOKEN_URL:-https://api.weixin.qq.com/cgi-bin/token}"
      IDENTITY_WEAPP_SESSION_URL: "${IDENTITY_WEAPP_SESSION_URL:-https://api.weixin.qq.com/sns/jscode2session}"
      IDENTITY_WEAPP_QRCODE_URL: "${IDENTITY_WEAPP_QRCODE_URL:-https://api.weixin.qq.com/wxa/getwxacodeunlimit}"
      IDENTITY_WEAPP_PHONE_NUMBER_URL: "${IDENTITY_WEAPP_PHONE_NUMBER_URL:-https://api.weixin.qq.com/wxa/business/getuserphonenumber}"
      IDENTITY_ALIPAY_APP_ID: "${IDENTITY_ALIPAY_APP_ID:-}"
      IDENTITY_ALIPAY_PRIVATE_KEY: "${IDENTITY_ALIPAY_PRIVATE_KEY:-}"
      IDENTITY_ALIPAY_PUBLIC_KEY: "${IDENTITY_ALIPAY_PUBLIC_KEY:-}"
      IDENTITY_ALIPAY_GATEWAY_URL: "${IDENTITY_ALIPAY_GATEWAY_URL:-https://openapi.alipay.com/gateway.do}"
      IDENTITY_ALIPAY_SIGN_TYPE: "${IDENTITY_ALIPAY_SIGN_TYPE:-RSA2}"
    ports:
      - "8081:8081"
    depends_on:
      postgres:
        condition: service_healthy

  commerce:
    build:
      context: ../..
      dockerfile: services/commerce/Dockerfile
    environment:
      COMMERCE_HTTP_ADDR: ":8082"
      COMMERCE_DB_DSN: "postgres://commerce:commerce@postgres:5432/commerce?sslmode=disable"
    ports:
      - "8082:8082"
    depends_on:
      postgres:
        condition: service_healthy

  payment:
    build:
      context: ../..
      dockerfile: services/payment/Dockerfile
    environment:
      PAYMENT_HTTP_ADDR: ":8083"
      PAYMENT_IDENTITY_BASE_URL: "http://identity:8081"
    ports:
      - "8083:8083"
    depends_on:
      identity:
        condition: service_started

  gateway-bff:
    build:
      context: ../..
      dockerfile: services/gateway-bff/Dockerfile
    environment:
      GATEWAY_HTTP_ADDR: ":8080"
      GATEWAY_IDENTITY_BASE_URL: "http://identity:8081"
      GATEWAY_COMMERCE_BASE_URL: "http://commerce:8082"
      GATEWAY_PAYMENT_BASE_URL: "http://payment:8083"
      GATEWAY_AI_BASE_URL: ""
      GATEWAY_PUBLIC_BASE_URL: "${GATEWAY_PUBLIC_BASE_URL:-http://localhost:8080}"
      GATEWAY_MEDIA_LOCAL_DIR: "${GATEWAY_MEDIA_LOCAL_DIR:-/data/media}"
      GATEWAY_IMAGE_PROXY_ALLOWLIST: "${GATEWAY_IMAGE_PROXY_ALLOWLIST:-images.unsplash.com}"
      GATEWAY_IMAGE_PROXY_TIMEOUT: "${GATEWAY_IMAGE_PROXY_TIMEOUT:-10s}"
      GATEWAY_IMAGE_PROXY_MAX_BYTES: "${GATEWAY_IMAGE_PROXY_MAX_BYTES:-8388608}"
      GATEWAY_IMAGE_PROXY_CACHE_MAX_AGE_SECONDS: "${GATEWAY_IMAGE_PROXY_CACHE_MAX_AGE_SECONDS:-3600}"
    ports:
      - "8080:8080"
    volumes:
      - ./media:/data/media
    depends_on:
      identity:
        condition: service_started
      commerce:
        condition: service_started
      payment:
        condition: service_started
